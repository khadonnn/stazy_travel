// stazy-booking-schema.prisma

generator client {
  provider        = "prisma-client"
  output   = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"] // Cần thiết cho pgvector
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// =========================================
// 1. MODEL: USER & PREFERENCES
// =========================================

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String?
  
  // Profile Info
  name     String
  nickname String?
  phone    String?
  gender   String?
  dob      DateTime?
  address  String?
  
  // Media
  avatar   String?
  bgImage  String?
  
  // Job/Bio
  jobName  String?
  desc     String? @db.Text
  
  role     Role    @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- RELATIONS ---
  hotels        Hotel[]         @relation("HotelAuthor")
  interactions  Interaction[]
  bookings      Booking[]
  reviews      Review[]
  // Quan hệ 1-1: Sở thích người dùng (Tách riêng để bảng User đỡ nặng)
  preference    UserPreference?
  recommendation Recommendation?

  // Log tìm kiếm (Optional)
  searchLogs    SearchQueryLog[]

  @@map("users")
}

model UserPreference {
  id              Int      @id @default(autoincrement())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interestedCategories String[]
  // Explicit Preferences (User tự chọn hoặc AI suy luận)
  favoriteAmenities String[] // ["pool", "gym", "sea_view"]
  favoriteCities    String[] // ["nha_trang", "da_nang"]
  
  // Behavioral Insights (AI tính toán từ History)
  avgPriceExpect    Decimal? @db.Decimal(12, 2) // Mức giá user hay xem/đặt
  preferredRatingMin Float?  // Vd: Chỉ thích rating > 4.0
  
  // Stats
  pastBookingCount  Int      @default(0)
  lastBookingAt     DateTime?

  updatedAt         DateTime @updatedAt

  @@map("user_preferences")
}

enum Role {
  USER
  AUTHOR
  ADMIN
}

// =========================================
// 2. MODEL: HOTEL & AI CONTEXT
// =========================================

model Hotel {
  id            Int      @id @default(autoincrement())
  
  // Relations
  authorId      String
  author        User     @relation("HotelAuthor", fields: [authorId], references: [id])
  
  categoryId    Int
  category      Category @relation(fields: [categoryId], references: [id])

  // Basic Info
  slug          String   @unique
  title         String
  roomName      String @default("Standard Room")
  featuredImage String
  galleryImgs   String[]
  description   String   @db.Text
  fullDescription String? @db.Text
  
  // Location & Map
  address       String
  map           Json     // { lat: ..., lng: ... }
  nearbyLandmarks String[] // ["cho_dem", "vinpearl"] -> Hỗ trợ gợi ý theo địa điểm

  // Pricing & Rooms
  price         Decimal  @db.Decimal(12, 2)
  saleOff       String?  // Text: "-30% Hè"
  saleOffPercent Int     @default(0) // Số: 30
  
  maxGuests     Int
  bedrooms      Int
  bathrooms     Int

  // Attributes & Context (Quan trọng cho Filtering)
  amenities     String[]
  tags          String[] // ["romantic", "pet-friendly", "business"]
  suitableFor   TripType[] // Enum array cho Postgres
  accessibility String[] // ["wheelchair", "elevator"]

  // Stats
  reviewStar    Float    @default(0)
  reviewCount   Int      @default(0)
  viewCount     Int      @default(0)
  commentCount  Int      @default(0)
  cancellationRate Float @default(0.0) // Tỷ lệ hủy (0.0 -> 1.0)
  
  // Flags
  like          Boolean  @default(false) // Cờ tạm (nên cân nhắc bỏ nếu dùng interaction)
  isAds         Boolean  @default(false)

  // --- AI / VECTOR FIELDS ---
  // Embedding cho hình ảnh (Visual search)
  imageVector   Unsupported("vector(512)")? 
  
  // Embedding cho chính sách (Semantic search: "tìm phòng cho hủy giờ chót")
  policies      String?  @db.Text
  policiesVector Unsupported("vector(512)")?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  interactions  Interaction[]
  bookings      Booking[]
  reviews      Review[]
  @@map("hotels")
}

enum TripType {
  BUSINESS
  FAMILY
  COUPLE
  SOLO
  GROUP
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?  @db.Text
  color       String?  
  icon        String?  
  thumbnail   String?
  count       Int      @default(0)
  
  hotels      Hotel[]

  @@map("categories")
}

// =========================================
// 3. MODEL: BOOKING & TRANSACTION (NEW)
// =========================================

model Booking {
  id            String   @id @default(uuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  hotelId       Int
  hotel         Hotel    @relation(fields: [hotelId], references: [id])

  // Guest Info (Snapshot tại thời điểm đặt - hỗ trợ auto-fill lần sau)
  guestName     String
  guestEmail    String
  guestPhone    String
  adults        Int      @default(1)
  children      Int      @default(0)

  // Schedule
  checkIn       DateTime
  checkOut      DateTime
  nights        Int      // Computed in logic

  // Payment Info
  basePrice     Decimal  @db.Decimal(12, 2)
  discount      Decimal  @db.Decimal(12, 2) @default(0)
  totalAmount   Decimal  @db.Decimal(12, 2)
  currency      String   @default("VND")

  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)
  paymentIntentId String?     // Stripe/VNPAY ID

  // Status
  status        BookingStatus @default(PENDING)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([hotelId])
  @@map("bookings")
}

enum BookingStatus {
  PENDING    // Đang giữ chỗ/chờ thanh toán
  CONFIRMED  // Đã thanh toán/Xác nhận
  CANCELLED  // Đã hủy
  COMPLETED  // Đã checkout xong
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  VNPAY
  BANK_TRANSFER
  CASH_ON_CHECKIN
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// =========================================
// 4. MODEL: AI INTERACTION & ANALYTICS
// =========================================

model Interaction {
  id        Int             @id @default(autoincrement())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?  @db.VarChar(255) // Để theo dấu chân người dùng trong 1 phiên
  hotelId   Int?            
  hotel     Hotel?          @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  
  type      InteractionType @default(VIEW)
  
  // --- THÊM TRƯỜNG NÀY ---
  // Nếu type == RATING, lưu số sao vào đây để dùng hàm _avg() của Prisma dễ dàng
  rating    Int?            
  
  metadata  Json?           
  timestamp DateTime        @default(now())

  @@index([userId, type])
  @@index([hotelId])
  @@map("interactions")
}

enum InteractionType {
  VIEW            // Xem chi tiết
  LIKE            // Thả tim
  SHARE           // Chia sẻ
  BOOK            // Đặt phòng thành công
  CLICK_BOOK_NOW  // Bấm nút đặt nhưng chưa thanh toán (High intent)
  CANCEL  // Hủy (Negative signal)
  SEARCH_QUERY    // Tìm kiếm (Lưu vào metadata)
  FILTER_APPLIED  // Lọc
  RATING
}

// Bảng riêng để lưu Recommendation Cache
model Recommendation {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  hotelIds  Int[]    // List ID gợi ý
  score     Json?    // { "hotel_1": 0.98, "hotel_2": 0.85 } - Giải thích độ phù hợp
  
  updatedAt DateTime @updatedAt

  @@map("recommendations")
}

// Bảng log Search Query chuyên biệt (Optional - để train AI)
model SearchQueryLog {
  id        Int      @id @default(autoincrement())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  query     String
  filters   Json?
  timestamp DateTime @default(now())

  @@map("search_query_logs")
}
// chart
model SystemMetric {
  id           String   @id @default(uuid())
  
  // Các chỉ số đánh giá mô hình AI
  rmse         Float    // Độ lỗi (Root Mean Square Error)
  precisionAt5 Float    // Độ chính xác trong Top 5
  recallAt5    Float    // Độ bao phủ trong Top 5
  
  // Metadata thêm (nếu cần)
  algorithm    String   @default("SVD") // Tên thuật toán: SVD, KNN, NeuralCF...
  datasetSize  Int?     // Số lượng dòng dữ liệu khi train
  executionTimeMs Int?  // (Optional) Thời gian chạy model (ms) để so sánh hiệu năng

  trainingHistory Json? // Lưu dạng: [ { "k": 10, "rmse": 0.85 }, { "k": 20, "rmse": 0.82 }, ... ]
  tuningParams Json? // Ví dụ: [{"param": 10, "metric": 0.8}, {"param": 20, "metric": 0.75}]
  createdAt    DateTime @default(now())

  @@map("system_metrics")
}
model Review {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  hotelId   Int
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  
  rating    Int      // 1-5 sao
  comment   String?  @db.Text // Nội dung bình luận (Dùng cho Word Cloud)
  
  // Sentiment Analysis (AI có thể phân tích tích cực/tiêu cực sau này)
  sentiment String?  // "POSITIVE", "NEGATIVE", "NEUTRAL"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@map("reviews")
}
model DailyStat {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique @db.Date 
  
  // 1. Chỉ số Kinh doanh cốt lõi (Business Core)
  totalRevenue     Decimal @default(0) @db.Decimal(12, 2)
  totalBookings    Int     @default(0) // Số booking thành công
  totalCancels     Int     @default(0) // Số booking bị hủy (QUAN TRỌNG)

  // 2. Chỉ số Phễu chuyển đổi (Conversion Funnel)
  totalViews       Int     @default(0) // Step 1
  totalClickBook   Int     @default(0) // Step 2 (High Intent - CLICK_BOOK_NOW)
  
  // 3. Chỉ số Tương tác (Engagement)
  totalLikes       Int     @default(0) 
  totalSearch      Int     @default(0)
  
  // 4. (Optional) Nếu bạn muốn lưu các loại phụ (Share, Comment...) 
  // mà không muốn tạo thêm cột, hãy dùng JSON
  miscInteractions Json?   // Vd: { "share": 5, "comment": 12 }

  createdAt DateTime @default(now())

  @@map("daily_stats")
}